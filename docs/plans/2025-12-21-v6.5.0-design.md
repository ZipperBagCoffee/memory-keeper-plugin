# v6.5.0 Design: File References + Concept Tags

## Goal
Add file references to facts.json + grouping index by concept

## Design

### 1. Session File Format Update

```markdown
## Decisions
- [architecture] Use React hooks: Better state management
  - files: src/hooks/useAuth.ts, src/components/Login.tsx
  - concepts: authentication, state-management

## Patterns
- [convention] Always test before commit
  - concepts: testing, workflow

## Issues
- [bugfix] Memory leak in dashboard: resolved
  - files: src/dashboard.ts
  - concepts: performance, react-hooks
```

### 2. facts.json Structure

```json
{
  "_meta": { "counter": 0, "lastSave": "..." },
  "decisions": [
    {
      "id": "d001",
      "type": "architecture",
      "date": "2025-12-21",
      "content": "Use React hooks",
      "reason": "Better state management",
      "files": ["src/hooks/useAuth.ts", "src/components/Login.tsx"],
      "concepts": ["authentication", "state-management"]
    }
  ],
  "patterns": [...],
  "issues": [...],
  "concepts": {
    "authentication": ["d001", "p003"],
    "state-management": ["d001", "d005"],
    "testing": ["p001", "p002"]
  }
}
```

### 3. Implementation Changes

**extractFacts() changes:**
- Parse `- files:` line under each item
- Parse `- concepts:` line under each item
- Auto-update concepts index

**add-* command changes:**
```bash
node counter.js add-decision "content" "reason" "architecture" "file1,file2" "concept1,concept2"
```

**search changes:**
```bash
node counter.js search --concept=authentication
node counter.js search --file=src/hooks
```

### 4. Parsing Rules

```
Line format:
- [type] Content: Reason
  - files: path1, path2
  - concepts: tag1, tag2

Regex for sub-items:
/^\s+-\s*(files|concepts):\s*(.+)$/i
```

## Backward Compatibility

- Empty array if files/concepts fields are missing
- Continue to work with existing session.md format
- Auto-create concepts index if not present
